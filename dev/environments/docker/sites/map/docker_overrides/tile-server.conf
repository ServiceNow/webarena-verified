<VirtualHost *:8080>
    ServerAdmin webmaster@localhost

    AddTileConfig /tile/ default
    LoadTileConfigFile /etc/renderd.conf
    ModTileRenderdSocketName /run/renderd/renderd.sock
    ModTileRequestTimeout 0
    ModTileMissingRequestTimeout 30

    # OSRM routing proxy - maps FOSSGIS-style URLs to local OSRM
    # /osrm/routed-{profile}/route/v1/... -> localhost:{port}/route/v1/...
    ProxyPass /osrm/routed-car/ http://localhost:5000/
    ProxyPassReverse /osrm/routed-car/ http://localhost:5000/
    ProxyPass /osrm/routed-bike/ http://localhost:5001/
    ProxyPassReverse /osrm/routed-bike/ http://localhost:5001/
    ProxyPass /osrm/routed-foot/ http://localhost:5002/
    ProxyPassReverse /osrm/routed-foot/ http://localhost:5002/

    # Nominatim geocoding proxy
    ProxyPass /nominatim/ http://localhost:8085/
    ProxyPassReverse /nominatim/ http://localhost:8085/

    # Rails website proxy (catch-all for everything else)
    # Exclude paths handled by mod_tile and other proxies
    ProxyPreserveHost On
    ProxyPass /tile/ !
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/

    DocumentRoot /var/www/html

    ErrorLog ${APACHE_LOG_DIR}/tile-error.log
    CustomLog ${APACHE_LOG_DIR}/tile-access.log combined

    Header set Access-Control-Allow-Origin "*"
</VirtualHost>
