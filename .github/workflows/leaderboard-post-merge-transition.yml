name: Leaderboard Post-Merge Transition

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - "leaderboard/data/submissions/pending/*.json"
  workflow_dispatch:
    inputs:
      submission_id:
        description: "Submission id to transition"
        required: true
        type: string
      status:
        description: "Terminal status"
        required: true
        type: choice
        options:
          - accepted
          - rejected
      result_reason:
        description: "Required when status is rejected"
        required: false
        type: string
      processed_at_utc:
        description: "Optional RFC3339 UTC timestamp ending in Z"
        required: false
        type: string

permissions:
  contents: write

jobs:
  process:
    name: Process pending submission to processed
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup

      - name: Resolve processing inputs
        id: inputs
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "submission_id=${{ github.event.inputs.submission_id }}" >> "$GITHUB_OUTPUT"
            echo "status=${{ github.event.inputs.status }}" >> "$GITHUB_OUTPUT"
            echo "result_reason=${{ github.event.inputs.result_reason }}" >> "$GITHUB_OUTPUT"
            echo "processed_at_utc=${{ github.event.inputs.processed_at_utc }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mapfile -t PENDING_FILES < <(
            git diff-tree --no-commit-id --name-only -r HEAD | grep -E '^leaderboard/data/submissions/pending/.+\.json$' || true
          )
          if [ "${#PENDING_FILES[@]}" -ne 1 ]; then
            echo "Expected exactly one pending submission file in merged commit, found ${#PENDING_FILES[@]}."
            printf '%s\n' "${PENDING_FILES[@]}"
            exit 1
          fi
          SUBMISSION_ID="$(basename "${PENDING_FILES[0]}" .json)"
          echo "submission_id=${SUBMISSION_ID}" >> "$GITHUB_OUTPUT"
          echo "status=accepted" >> "$GITHUB_OUTPUT"
          echo "result_reason=" >> "$GITHUB_OUTPUT"
          echo "processed_at_utc=" >> "$GITHUB_OUTPUT"

      - name: Apply control-plane process
        run: |
          set -euo pipefail
          CMD=(
            uv run inv dev.leaderboard.submission-process
            --submission-id "${{ steps.inputs.outputs.submission_id }}"
            --status "${{ steps.inputs.outputs.status }}"
          )
          if [ -n "${{ steps.inputs.outputs.processed_at_utc }}" ]; then
            CMD+=(--processed-at-utc "${{ steps.inputs.outputs.processed_at_utc }}")
          fi
          if [ -n "${{ steps.inputs.outputs.result_reason }}" ]; then
            CMD+=(--result-reason "${{ steps.inputs.outputs.result_reason }}")
          fi
          "${CMD[@]}"

      - name: Commit process update
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No control-plane changes produced."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add leaderboard/data/submissions
          git commit -m "Process submission ${{ steps.inputs.outputs.submission_id }} to ${{ steps.inputs.outputs.status }}"
          git push
