name: Release Publish

on:
  release:
    types: [published]

concurrency:
  group: release-publish-${{ github.event.inputs.tag || github.run_id }}
  cancel-in-progress: false

permissions:
  id-token: write # Required for trusted publishing

jobs:
  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      id-token: write
    environment:
      name: pypi
      url: https://pypi.org/p/webarena-verified
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          sync-args: --group dev

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  publish_docker:
    name: Publish Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tags
        id: image-tags
        run: |
          REPO_LC="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          IMAGE="ghcr.io/${REPO_LC}"
          VERSION="${{ github.event.release.tag_name }}"
          TAGS="$IMAGE:$VERSION"
          if [ "${{ github.event.release.prerelease }}" = "false" ]; then
            TAGS="$TAGS,$IMAGE:latest"
          fi
          echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            WBV_VERSION=${{ github.event.release.tag_name }}
          tags: ${{ steps.image-tags.outputs.tags }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish_hf_dataset:
    name: Publish HF Dataset
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          sync-args: --group dev

      - name: Build HF dataset artifacts
        run: uv run inv dev.release.build-hf-dataset --version "${{ github.event.release.tag_name }}"

      - name: Test HF dataset artifacts (local parity)
        run: uv run pytest tests/dataset/test_hf_dataset.py -v --hf-dataset-ref output/build/hf_dataset

      - name: Publish HF dataset
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          uv run inv dev.release.upload-hf-dataset \
            --version "${{ github.event.release.tag_name }}" \
            --folder-path output/build/hf_dataset \
            --token "${HF_TOKEN}"

  publish_docs:
    name: Publish Docs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          sync-args: --group dev
          configure-git-identity: "true"

      - name: Fetch gh-pages branch
        run: |
          git fetch origin gh-pages --depth=1 || echo "gh-pages branch does not exist yet"

      - name: Deploy release docs
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          uv run mike deploy --push --update-aliases "$VERSION" latest
          uv run mike set-default --push latest
